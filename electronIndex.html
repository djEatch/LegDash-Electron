<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="bootstrap.min.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"> -->

    <!-- this line removes any default padding and style. you might only need one of these values set. -->
    <style>
        body {
            padding: 0;
            margin: 0;
        }
    </style>

</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div id="dropDownDivEnvType"></div>
            <div id="dropDownDivSubEnv"></div>
        </div>
        <div class="row">
            <div class="table-responsive">
                <table id="serverTable" class="table table-light table-hover">
                    <thead class="thead-dark">
                        <td onclick="sortData('name','hostname')">Name</td>
                        <td onclick="sortData('hostname','name')">Hostname</td>
                        <!-- <td>Endpoint</td> -->
                        <td onclick="sortData('leg','name')">Leg</td>
                        <td onclick="sortData('status','name')">Status</td>
                        <td onclick="sortData('availability','name')">Availability</td>
                        <td>Retry</td>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <button id="refreshButton" class="btn btn-primary btn-block">refresh all</button>
            </div>
        </div>
        <div class="row">
            <div class="table-responsive" id="multiTableDiv">

            </div>
        </div>

        <!-- <div class="row">
            <div class="col-md-12">
                <button id="envPickedButton" class="btn btn-primary btn-block">FUDGE FT1</button>
            </div>
        </div> -->
    </div>

    <script>
        const electron = require('electron');
        const { ipcRenderer } = electron;

        let serverList = [];
        let envTypeList;
        let subLBList = [];
        let lbServerList = [];
        let requestCount = 0;
        let replyCount = 0;

        let sortOptions = { "currentField": null, "currentDir": -1 }

        const serverTable = document.querySelector('#tableBody');
        const refreshButton = document.querySelector('#refreshButton');
        refreshButton.addEventListener("click", refresh);

        // const fudgeButton = document.querySelector('#envPickedButton');
        // fudgeButton.addEventListener("click", fudgePick);

        const multiTableDiv = document.querySelector('#multiTableDiv');

        function refresh(e) {
            drawTable();
            drawMultiTables();
            requestAllServerDetails();
            //ipcRenderer.send('refreshList'); <---- this is for old list in text file....
        }

        function sortData(field, field2) {

            if (sortOptions.currentField == field) {
                sortOptions.currentDir *= -1;
            } else {
                sortOptions.currentField = field;
                sortOptions.currentDir = 1
            }

            serverList.sort(function (a, b) {

                var x = a[field] == null || (!a[field]) ? "zzz" : a[field].toLowerCase();
                var y = b[field] == null || (!b[field]) ? "zzz" : b[field].toLowerCase();

                if (x < y) { return -1 * sortOptions.currentDir; }
                if (x > y) { return 1 * sortOptions.currentDir; }

                if (x == y && field2) {
                    var x2 = a[field2] == null || (!a[field2]) ? "zzz" : a[field2].toLowerCase();
                    var y2 = b[field2] == null || (!b[field2]) ? "zzz" : b[field2].toLowerCase();
                    if (x2 < y2) { return -1 * sortOptions.currentDir; }
                    if (x2 > y2) { return 1 * sortOptions.currentDir; }
                }
                return 0;
            });
            drawTable();
            drawMultiTables();
        }

        function drawTable() {
            serverTable.innerHTML = "";
            let i = 0
            for (let server of serverList) {
                let row = serverTable.insertRow(i);
                let cell1 = row.insertCell();
                let cell2 = row.insertCell();
                //let cell3 = row.insertCell(2);
                let cell4 = row.insertCell();
                let cell5 = row.insertCell();
                let cell6 = row.insertCell();
                let cellbtn = row.insertCell();
                cell1.innerHTML = server.name;
                cell2.innerHTML = server.hostname + ":" + server.port;
                //cell3.innerHTML = server.endpoint;
                if (server.leg) {
                    cell4.innerHTML = server.leg;
                } else {
                    cell4.innerHTML = server.response;
                }
                cell5.innerHTML = server.status;
                cell6.innerHTML = server.availability;
                let refButton = document.createElement("button");
                refButton.textContent = "refresh";
                refButton.type = "button";
                refButton.setAttribute('data-server-name', server.name);
                refButton.setAttribute('data-server-hostname', server.hostname);
                refButton.setAttribute('data-server-endpoint', server.endpoint);
                refButton.setAttribute('data-server-port', server.port);
                refButton.onclick = individualRefresh;

                if (server.leg == "querying...") {
                    row.className = "table-warning"
                    refButton.classList = "btn btn-outline-warning";
                    refButton.textContent = "retry";
                } else if (server.response == "connection error, status:0") {
                    row.classList = "table-danger";
                    refButton.classList = "btn btn-danger";
                    refButton.textContent = "retry";
                } else {
                    row.classList = "table-success";
                    refButton.classList = "btn btn-success";
                    refButton.textContent = "refresh";
                }
                cellbtn.appendChild(refButton);
                i++;
            }
        }

        function drawMultiTables() {

            let tempLBList = []
            for (server of serverList) {
                tempLBList.push(server.LBName);
            }
            tempLBList = tempLBList.filter(onlyUnique);
            tempLBList = tempLBList.sort();
            multiTableDiv.innerHTML = "";

            for (currentLB of tempLBList) {
                var h = document.createElement("H2");                // Create a <h1> element
                var t = document.createTextNode(currentLB);     // Create a text node
                h.appendChild(t);  // Append the text to <h1>
                multiTableDiv.appendChild(h);

                let table = document.createElement("table");
                table.classList = "table table-light table-hover";

                // Create an empty <thead> element and add it to the table:
                var header = table.createTHead();
                header.classList = "thead-dark";

                // Create an empty <tr> element and add it to the first position of <thead>:
                var row = header.insertRow(0);

                // Insert a new cell (<td>) at the first position of the "new" <tr> element:
                let cell1 = row.insertCell();
                let cell2 = row.insertCell();
                let cell3 = row.insertCell();
                let cell4 = row.insertCell();
                let cell5 = row.insertCell();
                let cell6 = row.insertCell();
                let cell7 = row.insertCell();
                let cell8 = row.insertCell();
                let cell9 = row.insertCell();

                // Add some bold text in the new cell:
                cell1.innerHTML = "<b>Name</b>";
                cell2.innerHTML = "<b>Hostname</b>";
                cell2.addEventListener('click', function () {
                    sortData('name','hostname')
                });
                cell3.innerHTML = "<b>ASM Leg</b>";
                cell4.innerHTML = "<b>ASM Status</b>";
                cell5.innerHTML = "<b>ASM Availability</b>";
                cell6.innerHTML = "<b>LB State</b>";
                cell7.innerHTML = "<b>LB Leg</b>";
                cell8.innerHTML = "<b>Response Time</b>";
                cell9.innerHTML = "<b>Retry</b>";


                for (server of serverList) {
                    if (server.LBName == currentLB) {
                        let row = table.insertRow();
                        let cell1 = row.insertCell();
                        let cell2 = row.insertCell();
                        let cell3 = row.insertCell();
                        let cell4 = row.insertCell();
                        let cell5 = row.insertCell();
                        let cell6 = row.insertCell();
                        let cell7 = row.insertCell();
                        let cell8 = row.insertCell();
                        let cellbtn = row.insertCell();
                        cell1.innerHTML = server.name;
                        cell2.innerHTML = server.hostname + ":" + server.port;
                        if (server.leg) {
                            cell3.innerHTML = server.leg;
                        } else {
                            cell3.innerHTML = server.response;
                        }
                        cell4.innerHTML = server.status;
                        cell5.innerHTML = server.availability;
                        cell6.innerHTML = server.state;
                        cell7.innerHTML = server.servicegroupname.split('-')[2];
                        cell8.innerHTML = server.responseTime;
                        

                        let refButton = document.createElement("button");
                        refButton.textContent = "refresh";
                        refButton.type = "button";
                        refButton.setAttribute('data-server-name', server.name);
                        refButton.setAttribute('data-server-hostname', server.hostname);
                        refButton.setAttribute('data-server-endpoint', server.endpoint);
                        refButton.setAttribute('data-server-port', server.port);
                        refButton.onclick = individualRefresh;

                        if (server.leg == "querying...") {
                            row.className = "table-warning"
                            refButton.classList = "btn btn-outline-warning";
                            refButton.textContent = "retry";
                        } else if (server.response == "connection error, status:0") {
                            row.classList = "table-danger";
                            refButton.classList = "btn btn-danger";
                            refButton.textContent = "retry";
                        } else if (server.state == "DOWN") {
                            row.classList = "table-info";
                            refButton.classList = "btn btn-info";
                            refButton.textContent = "nothing";
                        } else {
                            row.classList = "table-success";
                            refButton.classList = "btn btn-success";
                            refButton.textContent = "refresh";
                        }
                        cellbtn.appendChild(refButton);
                    }
                }
                multiTableDiv.appendChild(table);

            }
        }

        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        ipcRenderer.on('updateEnvTypeList', function (e, _envTypeData) {
            updateEnvTypeList(_envTypeData);
        })

        function updateEnvTypeList(envTypeData) {
            envTypeList = envTypeData;

            dropDownDivEnvType = document.querySelector('#dropDownDivEnvType');
            let newList = document.createElement("select");

            for (env of envTypeList) {
                newList.appendChild(new Option(env.envname, env.envname));
            }
            newList.addEventListener('change', function () {
                itemtoKill = document.querySelector('#pickSubEnvBtn');
                if (itemtoKill) { itemtoKill.parentNode.removeChild(itemtoKill); };
                itemtoKill = document.querySelector('#dropDownSubEnv');
                if (itemtoKill) { itemtoKill.parentNode.removeChild(itemtoKill); };
                serverList = [];
                drawTable();
                drawMultiTables();
            })
            dropDownDivEnvType.appendChild(newList);

            let pickEnvTypeBtn = document.createElement("button");
            pickEnvTypeBtn.textContent = "Select";
            pickEnvTypeBtn.type = "button";
            pickEnvTypeBtn.classList = "btn-primary btn-block";
            pickEnvTypeBtn.addEventListener('click', function () {
                itemtoKill = document.querySelector('#pickSubEnvBtn');
                if (itemtoKill) { itemtoKill.parentNode.removeChild(itemtoKill); };
                itemtoKill = document.querySelector('#dropDownSubEnv');
                if (itemtoKill) { itemtoKill.parentNode.removeChild(itemtoKill); };
                serverList = [];
                drawTable();
                drawMultiTables();
                pickedEnvType(newList.value);
            });
            dropDownDivEnvType.appendChild(pickEnvTypeBtn);
        }

        function pickedEnvType(_envType) {

            let envDetails;
            if (envDetails = getMasterLBAddressForEnvType(_envType, envTypeList)) {
                let masterLBAddress = 'http://' + envDetails.hostname + envDetails.endpoint;
                getRequest(gotSubLBList, masterLBAddress, envDetails, envDetails.username, envDetails.password);
            } else {
                console.log(_envType + " doesn't exist");
            }
        }

        function getMasterLBAddressForEnvType(_envType, _envTypeList) {
            for (env of _envTypeList) {
                if (env.envname == _envType) {
                    return env;
                    break;
                }
            }
            return false;
        }

        function setupSubEnvDropDown(_inList, _envDetails) {
            dropDownDivSubEnv = document.querySelector('#dropDownDivSubEnv');
            let newList = document.createElement("select");
            let tempEnvList = [];
            for (item of _inList) {
                tempEnvList.push(item.splitEnvName);
            }
            //let tempEnvList = _inList.filter((elem, index, self) => self.findIndex((t) => { return (t.x === elem.x && t.y === elem.y) }) === index)
            tempEnvList = tempEnvList.filter(onlyUnique);
            for (env of tempEnvList) {
                newList.appendChild(new Option(env, env));
            }
            dropDownDivSubEnv.appendChild(newList);
            newList.id = "dropDownSubEnv"

            let pickSubEnvBtn = document.createElement("button");
            pickSubEnvBtn.textContent = "Select";
            pickSubEnvBtn.id = "pickSubEnvBtn"
            pickSubEnvBtn.type = "button";
            pickSubEnvBtn.classList = "btn-primary btn-block";
            pickSubEnvBtn.addEventListener('click', function () {
                getServerListFromSubLBList(newList.value, subLBList, _envDetails);
            });
            dropDownDivSubEnv.appendChild(pickSubEnvBtn);
        }

        function gotSubLBList(data, _envDetails) {
            subLBList = [];
            try {
                let masterLBResponse = JSON.parse(data)
                subLBList = masterLBResponse.lbvserver;
                for (subLB of subLBList) {
                    subtext = subLB.name.split('-');
                    subLB.splitEnvName = subtext[0];
                    subLB.splitServerType = subtext[1];
                    subLB.splitLeg = subtext[2];
                }

            }
            catch (err) {
                console.log('BAD Response from Master LB');
                console.log(err);
            }
            setupSubEnvDropDown(subLBList, _envDetails);
        }

        function getServerListFromSubLBList(_selectedEnvName, _subLBList, _envDetails) {

            lbServerList = [];
            requestCount = subLBList.length;
            replyCount = 0;

            for (subLB of subLBList) {
                if (subLB.splitEnvName == _selectedEnvName) {
                    let subLBAddress = 'http://' + _envDetails.hostname + _envDetails.endpoint + "/" + subLB.name + "?statbindings=yes";
                    //http://10.141.129.210/nitro/v1/stat/lbvserver/FT1-UIS-X?statbindings=yes
                    getRequest(gotSubServerList, subLBAddress, subLB, _envDetails.username, _envDetails.password);
                }
            }

        }

        function gotSubServerList(data, _subLB) {
            replyCount++;
            try {
                let subLBResponse = JSON.parse(data)
                let subLBServerList = subLBResponse.lbvserver[0].servicegroupmember;
                for (subLBServer of subLBServerList) {
                    subLBServer.LBName = _subLB.name;
                    lbServerList.push(subLBServer);
                }
                console.log(lbServerList.length);
            }
            catch (err) {
                console.log('BAD Response from Sub LB');
                console.log(_subLB);
                console.log(err);
            }
            finally {
                if (requestCount == replyCount) { processServers() };
            }

        }

        function processServers() {
            console.log('AllSubLBsReplied');

            serverList = [];
            for (let lbServer of lbServerList) {
                splitTextQuestion = lbServer.servicegroupname.split('?');
                splitTextHyphen = splitTextQuestion[0].split('-');
                lbServer.name = splitTextQuestion[0].slice(0, -4);
                lbServer.ip = lbServer.primaryipaddress;
                lbServer.hostname = splitTextQuestion[1] + ".corp.internal";
                lbServer.port = splitTextQuestion[2];
                lbServer.endpoint = "/application-status-monitor/rest/applicationstatusmonitor/status.json";
                lbServer.response = "querying...";
                lbServer.leg = null;
                lbServer.availability = null;
                lbServer.status = null;
            }

            serverList = lbServerList;
            drawTable();
            drawMultiTables();
            requestAllServerDetails();

        }


        function requestAllServerDetails() {
            for (let server of serverList) {
                server.leg = "querying...";
                getServerDetails(server);
            }
        }

        function individualRefresh(e) {
            for (let server of serverList) {
                //if (server.name == e.target.attributes['data-server-name'].value && server.hostname == e.target.attributes['data-server-hostname'].value) {
                if (server.port == e.target.attributes['data-server-port'].value && server.hostname == e.target.attributes['data-server-hostname'].value) {
                    server.leg = "querying...";
                    drawTable();
                    drawMultiTables();
                    if(server.name == e.target.attributes['data-server-name'].value){
                        getServerDetails(server);
                    }
                }
            }
        }

        function getServerDetails(server) {

            let url = "http://" + server.hostname + ":" + server.port + server.endpoint;
            getRequest(updateServerResults, url, server);
        }

        function getRequest(callback, url, id, username, password) {
            var xhr = new XMLHttpRequest();
            var startTime = new Date();
            xhr.open("GET", url, true);
            xhr.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            if (username) {
                xhr.setRequestHeader("Authorization", "Basic " + btoa(username + ":" + password))
            }

            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var endTime = new Date();
                    callback(xhr.responseText, id, endTime-startTime);
                }
                if (xhr.readyState == 4 && xhr.status != 200) {
                    callback("connection error, status:" + xhr.status, id, endTime-startTime);
                }
            }
        }

        function updateServerResults(data, _server, timing) {
            //format = {"status":{"available":true,"currentStatus":"UP_AND_RUNNING","label":"LEGX"}}
            for (server of serverList) {
                if (_server.hostname == server.hostname && _server.port == server.port) {
                    server.response = data;
                    server.responseTime = timing;
                    try {
                        server.leg = JSON.parse(data).status.label;
                        //break;
                    } catch (e) {
                        server.leg = data;
                    }
                    try {
                        server.status = JSON.parse(data).status.currentStatus;
                        //break;
                    } catch (e) {
                        server.status = null;
                    }
                    try {
                        server.availability = JSON.parse(data).status.available.toString();
                        //break;
                    } catch (e) {
                        server.availability = null;
                    }
                }
            }
            drawTable();
            drawMultiTables();
        }

        class Server {

            constructor(name, hostname, port, endpoint) {
                this.name = name;
                this.hostname = hostname;
                this.port = port;
                this.endpoint = endpoint;
                this.response = null;
                this.leg = null;
                this.availability = null;
                this.status = null;
            }
        }

        function sortTable(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("serverTable");
            switching = true;
            // Set the sorting direction to ascending:
            dir = "asc";
            /* Make a loop that will continue until
            no switching has been done: */
            while (switching) {
                // Start by saying: no switching is done:
                switching = false;
                rows = table.getElementsByTagName("TR");
                /* Loop through all table rows (except the
                first, which contains table headers): */
                for (i = 1; i < (rows.length - 1); i++) {
                    // Start by saying there should be no switching:
                    shouldSwitch = false;
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    /* Check if the two rows should switch place,
                    based on the direction, asc or desc: */
                    if (dir == "asc") {
                        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true;
                            break;
                        }
                    } else if (dir == "desc") {
                        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true;
                            break;
                        }
                    }
                }
                if (shouldSwitch) {
                    /* If a switch has been marked, make the switch
                    and mark that a switch has been done: */
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    // Each time a switch is done, increase this count by 1:
                    switchcount++;
                } else {
                    /* If no switching has been done AND the direction is "asc",
                    set the direction to "desc" and run the while loop again. */
                    if (switchcount == 0 && dir == "asc") {
                        dir = "desc";
                        switching = true;
                    }
                }
            }
        }
    </script>
</body>

</html>